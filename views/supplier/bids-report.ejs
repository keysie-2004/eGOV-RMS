<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Supplier Bids Report - Hareneth</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
  <link rel="icon" href="/img/Calapan_City_Logo.png" type="image/png">
  <style>
    @media print {
      body { margin: 0; padding: 0; font-size: 12pt; }
      .max-w-4xl { width: 100%; max-width: none; }
      .bg-white { background-color: transparent; }
      .shadow-md { box-shadow: none; }
      .p-6 { padding: 0; }
      .mt-8 { margin-top: 0; }
      .mb-4 { margin-bottom: 0; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #000; padding: 8px; text-align: left; }
      th { background-color: #f3f4f6; }
      .no-print { display: none; }
      .number-cell { text-align: right; font-family: 'Courier New', monospace; }
      .date-cell { white-space: nowrap; }
    }
    .number-cell { text-align: right; font-family: 'Courier New', monospace; }
    .date-cell { white-space: nowrap; }
  </style>
</head>
<body class="bg-blue-50 font-sans">
  <!-- Include Sidebar -->
  <%- include('../partials/supplierSidebar') %>

  <!-- Main Content -->
  <div class="lg:ml-64 p-4 lg:p-10">
    <div class="w-full">
      <div class="bg-white p-6 lg:p-10 rounded-lg shadow-sm">
        <h1 class="text-2xl font-bold text-blue-700 mb-6">Supplier Bids Report</h1>

        <!-- Report Header -->
        <div class="mb-8">
          <p class="text-sm text-gray-500">Generated on <%= new Date().toLocaleString('en-PH', { dateStyle: 'long', timeStyle: 'short', timeZone: 'Asia/Manila' }) %></p>
          <p class="text-sm text-gray-500">Supplier: <%= supplier ? supplier.company_name : 'N/A' %> (ID: <%= supplier ? supplier.supplier_id : 'N/A' %>)</p>
          <p class="text-sm text-gray-500">Filter Applied: <%= statusFilter.charAt(0).toUpperCase() + statusFilter.slice(1) %></p>
        </div>

        <!-- Filter Form -->
        <form action="/supplier/bids-report" method="GET" class="space-y-4 no-print mb-8">
          <div>
            <label for="statusFilter" class="block text-sm font-medium text-gray-700">Status Filter</label>
            <select name="status" id="statusFilter" class="block w-full p-3 border rounded-lg bg-blue-50 mt-1 mb-4">
              <option value="all" <%= statusFilter === 'all' ? 'selected' : '' %>>All Bids</option>
              <option value="pending" <%= statusFilter === 'pending' ? 'selected' : '' %>>Pending</option>
              <option value="closed" <%= statusFilter === 'closed' ? 'selected' : '' %>>Closed</option>
              <option value="awarded" <%= statusFilter === 'awarded' ? 'selected' : '' %>>Awarded</option>
            </select>
          </div>
          <div>
            <label for="department" class="block text-sm font-medium text-gray-700">Department</label>
            <input type="text" name="department" id="department" value="<%= typeof department !== 'undefined' ? department : '' %>" class="block w-full p-3 border rounded-lg bg-blue-50 mt-1 mb-4" placeholder="Enter department">
          </div>
          <div>
            <label for="dateStart" class="block text-sm font-medium text-gray-700">Start Date</label>
            <input type="date" name="dateStart" id="dateStart" value="<%= typeof dateStart !== 'undefined' ? dateStart : '' %>" class="block w-full p-3 border rounded-lg bg-blue-50 mt-1 mb-4">
          </div>
          <div>
            <label for="dateEnd" class="block text-sm font-medium text-gray-700">End Date</label>
            <input type="date" name="dateEnd" id="dateEnd" value="<%= typeof dateEnd !== 'undefined' ? dateEnd : '' %>" class="block w-full p-3 border rounded-lg bg-blue-50 mt-1 mb-4">
          </div>
          <button type="submit" class="bg-blue-700 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-blue-800">
            Generate Report
          </button>
        </form>

        <!-- Report Data -->
        <% if (data && data.length > 0) { %>
          <div class="mt-8">
            <h2 class="text-xl font-bold text-blue-700 mb-4">Bids Summary by Day and Department</h2>
            <div class="mb-4">
              <p class="text-sm text-gray-600">Found <%= data.length %> record(s)</p>
            </div>
            <div class="flex space-x-4 mb-4 no-print">
              <button onclick="printReport()" class="bg-green-500 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-green-600">
                <i class="fas fa-print mr-2"></i>Print Report
              </button>
              <a href="/supplier/bids-report/csv?status=<%= statusFilter %>&department=<%= encodeURIComponent(department || '') %>&dateStart=<%= dateStart || '' %>&dateEnd=<%= dateEnd || '' %>" class="bg-yellow-500 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-yellow-600">
                <i class="fas fa-file-csv mr-2"></i>Export to CSV
              </a>
              <a href="/supplier/bids-report/pdf?status=<%= statusFilter %>&department=<%= encodeURIComponent(department || '') %>&dateStart=<%= dateStart || '' %>&dateEnd=<%= dateEnd || '' %>" class="bg-red-500 text-white px-6 py-3 rounded-lg shadow-sm hover:bg-red-600">
                <i class="fas fa-file-pdf mr-2"></i>Export to PDF
              </a>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full bg-white border border-gray-300">
                <thead>
                  <tr class="bg-blue-100">
                    <th class="py-2 px-4 border-b text-left">Date</th>
                    <th class="py-2 px-4 border-b text-left">Department</th>
                    <th class="py-2 px-4 border-b text-right">Number of Bids</th>
                    <th class="py-2 px-4 border-b text-right">Total Bid Amount</th>
                    <th class="py-2 px-4 border-b text-right">Average Bid Amount</th>
                  </tr>
                </thead>
                <tbody>
                  <% data.forEach(row => { %>
                    <tr class="hover:bg-gray-50">
                      <td class="py-2 px-4 border-b date-cell"><%= row.date %></td>
                      <td class="py-2 px-4 border-b"><%= row.department %></td>
                      <td class="py-2 px-4 border-b number-cell"><%= row.bid_count %></td>
                      <td class="py-2 px-4 border-b number-cell">₱<%= parseFloat(row.total_amount).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                      <td class="py-2 px-4 border-b number-cell">₱<%= parseFloat(row.avg_amount).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                    </tr>
                  <% }); %>
                </tbody>
                <tfoot>
                  <tr class="bg-gray-100 font-semibold">
                    <td colspan="2" class="py-2 px-4 border-b text-right">Total:</td>
                    <td class="py-2 px-4 border-b number-cell"><%= data.reduce((sum, row) => sum + parseInt(row.bid_count), 0) %></td>
                    <td class="py-2 px-4 border-b number-cell">₱<%= data.reduce((sum, row) => sum + parseFloat(row.total_amount), 0).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                    <td class="py-2 px-4 border-b number-cell">₱<%= (data.reduce((sum, row) => sum + parseFloat(row.total_amount), 0) / data.reduce((sum, row) => sum + parseInt(row.bid_count), 0)).toLocaleString('en-PH', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        <% } else if (typeof statusFilter !== 'undefined' && statusFilter !== null) { %>
          <div class="mt-8">
            <div class="bg-yellow-50 border border-yellow-200 rounded-md p-4">
              <div class="flex">
                <div class="flex-shrink-0">
                  <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                </div>
                <div class="ml-3">
                  <h3 class="text-sm font-medium text-yellow-800">No data found</h3>
                  <div class="mt-2 text-sm text-yellow-700">
                    <p>No bids match the selected filters. Try adjusting your search criteria.</p>
                    <p><strong>Debug Info:</strong></p>
                    <p>Supplier ID: <%= supplier ? supplier.supplier_id : 'Not available' %></p>
                    <p>Filter Applied: <%= statusFilter %></p>
                    <p>Department: <%= department || 'All' %></p>
                    <p>Date Range: <%= dateStart || 'N/A' %> to <%= dateEnd || 'N/A' %></p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        <% } %>
      </div>
    </div>
  </div>

  <script>
    function printReport() {
      window.print();
    }
  </script>
</body>
</html>