<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Signature Management</title>
  <link href="/src/table.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link rel="icon" href="/img/Calapan_City_Logo.png" type="image/png"/>
</head>

<body class="bg-blue-50 font-sans min-h-screen">
  <!-- Include Sidebar -->
  <%- include('partials/sidebar') %>

  <!-- Main Content -->
  <div class="lg:ml-64 p-7 lg:p-10">
    <div class="bg-white p-6 lg:p-10 rounded-lg shadow-sm">
      <h2 class="text-2xl font-bold text-blue-700 mb-6">Signatures</h2>

      <!-- Add Signature and View Archived Buttons -->
      <div class="flex flex-wrap gap-3 mb-6">
        <button class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 flex items-center" id="btnAddSignature">
          <i class="fas fa-plus mr-2"></i>Add Signature
        </button>
        <button class="bg-gray-400 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-gray-500 flex items-center" id="btnViewArchived">
          <i class="fas fa-archive mr-2"></i>View Archived
        </button>
      </div>

      <!-- Signatures Table -->
      <div class="overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-blue-700 text-white">
              <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">ID</th>
              <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Employee Name</th>
              <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Position</th>
              <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Document Signed</th>
              <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Signature</th>
              <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Created At</th>
              <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody>
            <% signatures.forEach(signature => { %>
              <tr class="border-b hover:bg-blue-50">
                <td class="p-3 font-medium"><%= signature.id %></td>
                <td class="p-3 font-medium"><%= signature.employee_name %></td>
                <td class="p-3"><%= signature.position %></td>
                <td class="p-3"><%= signature.signed_document || 'N/A' %></td>
                <td class="p-3">
                  <% if (signature.signature) { %>
                    <img src="<%= signature.signature %>" class="max-w-full h-auto border border-gray-200" style="max-height: 50px;">
                  <% } else { %>
                    <span class="text-gray-500">No signature</span>
                  <% } %>
                </td>
                <td class="p-3">
                  <%= new Date(signature.created_at).toLocaleDateString() %>
                </td>
                <td class="p-3">
                  <div class="flex space-x-2">
                    <button class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-blue-700 btn-edit"
                      data-id="<%= signature.id %>"
                      data-employee-name="<%= signature.employee_name %>"
                      data-position="<%= signature.position %>"
                      data-signed-document="<%= signature.signed_document %>"
                      data-signature="<%= signature.signature %>">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button class="bg-red-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-red-700 btn-archive"
                      data-id="<%= signature.id %>">
                      <i class="fas fa-archive"></i>
                    </button>
                  </div>
                </td>
              </tr>
            <% }); %>
            <% if (signatures.length === 0) { %>
              <tr>
                <td colspan="7" class="p-3 text-center text-gray-500">No signatures found</td>
              </tr>
            <% } %>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Add Signature Modal -->
  <div id="addModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-blue-700">Add Signature</h3>
            <button onclick="closeAddModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <form id="addForm" action="/signatures/add" method="POST">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-gray-700 font-medium mb-2">Employee Name</label>
                <input type="text" name="employee_name" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              </div>
              <div>
                <label class="block text-gray-700 font-medium mb-2">Position</label>
                <input type="text" name="position" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2">Document Signed</label>
              <input type="text" name="signed_document" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2">Signature</label>
              <div class="signature-container">
                <canvas id="signatureCanvas"></canvas>
              </div>
              <div class="signature-actions">
                <button type="button" id="clearSignature" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-300">
                  <i class="fas fa-eraser mr-1"></i>Clear
                </button>
                <span class="text-sm text-gray-500">Sign in the box above</span>
              </div>
              <input type="hidden" name="signature" id="signatureData">
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="closeAddModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Save Signature
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Edit Signature Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-2xl">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-blue-700">Edit Signature</h3>
            <button onclick="closeEditModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <form id="editForm" method="POST">
            <input type="hidden" name="id" id="editId">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="block text-gray-700 font-medium mb-2">Employee Name</label>
                <input type="text" name="employee_name" id="editEmployeeName" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              </div>
              <div>
                <label class="block text-gray-700 font-medium mb-2">Position</label>
                <input type="text" name="position" id="editPosition" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500" required>
              </div>
            </div>
            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2">Document Signed</label>
              <input type="text" name="signed_document" id="editSignedDocument" class="w-full p-3 border rounded-lg bg-gray-100 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
            </div>
            <div class="mb-6">
              <label class="block text-gray-700 font-medium mb-2">Signature</label>
              <div class="signature-container">
                <canvas id="editSignatureCanvas"></canvas>
              </div>
              <div class="signature-actions">
                <button type="button" id="clearEditSignature" class="bg-gray-200 text-gray-600 px-4 py-2 rounded-lg hover:bg-gray-300">
                  <i class="fas fa-eraser mr-1"></i>Clear
                </button>
                <span class="text-sm text-gray-500">Draw to update signature</span>
              </div>
              <input type="hidden" name="signature" id="editSignatureData">
            </div>
            <div class="mb-4 p-3 bg-gray-50 rounded-lg">
              <p class="text-sm font-medium text-gray-700 mb-1">Current Signature:</p>
              <div class="flex items-center">
                <img id="currentSignatureImage" src="" class="max-w-full h-auto border border-gray-200" style="max-height: 60px;">
                <span class="ml-3 text-sm text-gray-500">This will be replaced if you sign above</span>
              </div>
            </div>
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="closeEditModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                Update Signature
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Archive Signature Modal -->
  <div id="archiveModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-md">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-red-700">Archive Signature</h3>
            <button onclick="closeArchiveModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <p class="text-gray-700 mb-6">Are you sure you want to archive this signature? Archived signatures can be restored later.</p>
          <form id="archiveForm" method="POST">
            <input type="hidden" name="id" id="archiveId">
            <div class="flex justify-end space-x-3">
              <button type="button" onclick="closeArchiveModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
                Cancel
              </button>
              <button type="submit" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors">
                Archive
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- View Archived Modal -->
  <div id="viewArchivedModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl max-h-[80vh] overflow-y-auto">
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold text-blue-700">Archived Signatures</h3>
            <button onclick="closeViewArchivedModal()" class="text-gray-400 hover:text-gray-600">
              <i class="fas fa-times text-xl"></i>
            </button>
          </div>
          <div class="overflow-x-auto">
            <table class="w-full border-collapse">
              <thead>
                <tr class="bg-blue-700 text-white">
                  <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Employee Name</th>
                  <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Position</th>
                  <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Document Signed</th>
                  <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Signature</th>
                  <th class="p-3 text-left text-xs font-medium uppercase tracking-wider">Actions</th>
                </tr>
              </thead>
              <tbody>
                <% archivedSignatures.forEach(signature => { %>
                  <tr class="border-b hover:bg-blue-50">
                    <td class="p-3 font-medium"><%= signature.employee_name %></td>
                    <td class="p-3"><%= signature.position %></td>
                    <td class="p-3"><%= signature.signed_document || 'N/A' %></td>
                    <td class="p-3">
                      <% if (signature.signature) { %>
                        <img src="<%= signature.signature %>" class="max-w-full h-auto border border-gray-200" style="max-height: 50px;">
                      <% } else { %>
                        <span class="text-gray-500">No signature</span>
                      <% } %>
                    </td>
                    <td class="p-3">
                      <form action="/signatures/unarchive" method="POST" class="inline">
                        <input type="hidden" name="id" value="<%= signature.id %>">
                        <button type="submit" class="bg-green-600 text-white px-4 py-2 rounded-lg shadow-sm hover:bg-green-700">
                          <i class="fas fa-undo"></i>
                        </button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
                <% if (archivedSignatures.length === 0) { %>
                  <tr>
                    <td colspan="5" class="p-3 text-center text-gray-500">No archived signatures found</td>
                  </tr>
                <% } %>
              </tbody>
            </table>
          </div>
          <div class="flex justify-end space-x-3 mt-6">
            <button type="button" onclick="closeViewArchivedModal()" class="px-4 py-2 text-gray-600 bg-gray-200 rounded-lg hover:bg-gray-300 transition-colors">
              Cancel
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>
</html>

  <!-- Signature Pad Library -->
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
  
  <script>
// Initialize signature pads
let signaturePad, editSignaturePad;

document.addEventListener('DOMContentLoaded', function() {
  // Initialize main signature pad
  const canvas = document.getElementById('signatureCanvas');
  initializeSignaturePad(canvas, true);
  
  // Initialize edit signature pad
  const editCanvas = document.getElementById('editSignatureCanvas');
  initializeSignaturePad(editCanvas, false);
  
  // Handle window resize
  window.addEventListener('resize', function() {
    resizeCanvas(canvas, signaturePad);
    resizeCanvas(editCanvas, editSignaturePad);
  });

  // Clear buttons
  document.getElementById('clearSignature').addEventListener('click', function() {
    signaturePad.clear();
  });
  
  document.getElementById('clearEditSignature').addEventListener('click', function() {
    editSignaturePad.clear();
  });
  
  // Form submission handlers
  document.getElementById('addForm').addEventListener('submit', function(e) {
    if (signaturePad.isEmpty()) {
      alert('Please provide a signature');
      e.preventDefault();
    } else {
      document.getElementById('signatureData').value = signaturePad.toDataURL('image/png');
    }
  });
  
  document.getElementById('editForm').addEventListener('submit', function(e) {
    if (!editSignaturePad.isEmpty()) {
      document.getElementById('editSignatureData').value = editSignaturePad.toDataURL('image/png');
    }
  });
});

// Initialize a signature pad with proper dimensions
function initializeSignaturePad(canvas, isMainPad) {
  // Set canvas dimensions
  const ratio = window.devicePixelRatio || 1;
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  canvas.getContext('2d').scale(ratio, ratio);
  
  // Create the signature pad
  const pad = new SignaturePad(canvas, {
    backgroundColor: 'rgb(248, 250, 252)',
    penColor: 'rgb(30, 58, 138)'
  });
  
  if (isMainPad) {
    signaturePad = pad;
  } else {
    editSignaturePad = pad;
  }
  
  return pad;
}

// Resize canvas properly
function resizeCanvas(canvas, pad) {
  const ratio = window.devicePixelRatio || 1;
  const savedData = pad ? pad.toDataURL() : null;
  
  canvas.width = canvas.offsetWidth * ratio;
  canvas.height = canvas.offsetHeight * ratio;
  canvas.getContext('2d').scale(ratio, ratio);
  
  if (pad) {
    pad.clear();
    if (savedData) {
      const img = new Image();
      img.src = savedData;
      img.onload = () => {
        canvas.getContext('2d').drawImage(img, 0, 0);
      };
    }
  }
}

// Modal control functions
document.getElementById('btnAddSignature').addEventListener('click', function() {
  document.getElementById('addModal').classList.remove('hidden');
  // Resize the canvas when modal opens
  setTimeout(() => {
    const canvas = document.getElementById('signatureCanvas');
    resizeCanvas(canvas, signaturePad);
    signaturePad.clear();
  }, 50);
});

function closeAddModal() {
  document.getElementById('addModal').classList.add('hidden');
}

document.getElementById('btnViewArchived').addEventListener('click', function() {
  document.getElementById('viewArchivedModal').classList.remove('hidden');
});

function closeViewArchivedModal() {
  document.getElementById('viewArchivedModal').classList.add('hidden');
}

document.querySelectorAll('.btn-archive').forEach(button => {
  button.addEventListener('click', function() {
    document.getElementById('archiveId').value = this.dataset.id;
    document.getElementById('archiveForm').action = `/signatures/archive/${this.dataset.id}`;
    document.getElementById('archiveModal').classList.remove('hidden');
  });
});

function closeArchiveModal() {
  document.getElementById('archiveModal').classList.add('hidden');
}

document.querySelectorAll('.btn-edit').forEach(button => {
  button.addEventListener('click', function() {
    document.getElementById('editId').value = this.dataset.id;
    document.getElementById('editEmployeeName').value = this.dataset.employeeName;
    document.getElementById('editPosition').value = this.dataset.position;
    document.getElementById('editSignedDocument').value = this.dataset.signedDocument || '';
    document.getElementById('editForm').action = `/signatures/edit/${this.dataset.id}`;
    
    // Show current signature if it exists
    if (this.dataset.signature) {
      document.getElementById('currentSignatureImage').src = this.dataset.signature;
      document.getElementById('currentSignature').style.display = 'block';
    } else {
      document.getElementById('currentSignature').style.display = 'none';
    }
    
    // Clear the edit signature pad and ensure proper dimensions
    document.getElementById('editModal').classList.remove('hidden');
    setTimeout(() => {
      const editCanvas = document.getElementById('editSignatureCanvas');
      resizeCanvas(editCanvas, editSignaturePad);
      editSignaturePad.clear();
      document.getElementById('editSignatureData').value = '';
    }, 50);
  });
});

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
}  
</script>
</body>
</html>