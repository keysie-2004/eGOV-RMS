<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Outgoing Reports Management</title>
<link rel="stylesheet" href="/fa/all.min.css">
    <link href="/src/table.css" rel="stylesheet"/>

  <link rel="icon" href="/img/Calapan_City_Logo.png" type="image/png"/>
</head>
<body class="bg-blue-50 font-sans">
  <%- include('partials/sidebar') %>

  <div class="lg:ml-64 p-7 lg:p-10">
    <div class="w-full">
      <div class="bg-white p-6 lg:p-10 rounded-lg shadow-sm">
        <div class="flex justify-between items-center mb-6 header-content">
          <h2 class="text-2xl font-bold text-blue-700">Outgoing Reports Management</h2>
          <div class="button-container">
            <button id="showActive" class="button-same-size no-border bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
              <i class="fas fa-eye mr-2"></i>
              <span>Show Active</span>
            </button>
            <button id="showArchived" class="button-same-size no-border bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition-colors">
              <i class="fas fa-archive mr-2"></i>
              <span>Show Archived</span>
            </button>
            <button id="refreshReports" class="button-same-size no-border bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors">
              <i class="fas fa-sync-alt mr-2"></i>
              <span>Refresh</span>
            </button>
          </div>
        </div>

        <!-- Search and Filter -->
        <div class="mb-6 relative">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-gray-400"></i>
            </div>
            <input type="text" id="search" class="w-full pl-10 p-3 border rounded-lg bg-blue-50 focus:outline-none focus:ring-2 focus:ring-blue-300" placeholder="Search by PR ID, department, or supplier">
          </div>
        </div>

        <!-- Reports Table -->
        <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
          <table class="min-w-full bg-white">
            <!-- Table Headers -->
            <thead>
              <tr class="bg-blue-600 text-white">
                <th class="py-3 px-4 text-left">PR ID</th>
                <th class="py-3 px-4 text-left">Department</th>
                <th class="py-3 px-4 text-left">Particulars</th>
                <th class="py-3 px-4 text-left">Amount</th>
                <th class="py-3 px-4 text-left">Supplier</th>
                <th class="py-3 px-4 text-left">Received By</th>
                <th class="py-3 px-4 text-left">Date Received</th>
                <th class="py-3 px-4 text-left">Transaction</th>
                <th class="py-3 px-4 text-left">Updated By</th>
                <th class="py-3 px-4 text-center">Actions</th>
              </tr>
            </thead>

            <!-- Table Body -->
            <tbody id="reportsTableBody" class="divide-y divide-gray-200">
              <% reports.forEach(report => { %>
                <tr class="hover:bg-gray-50 transition-colors <%= report.status === 'archived' ? 'bg-gray-100' : '' %>" data-status="<%= report.status || 'active' %>">
                  <td class="py-4 px-4"><%= report.pr_id %></td>
                  <td class="py-4 px-4"><%= report.department %></td>
                  <td class="py-4 px-4"><%= report.particulars || 'N/A' %></td>
                  <td class="py-4 px-4"><%= report.amount ? 'â‚±' + parseFloat(report.amount).toFixed(2) : 'N/A' %></td>
                  <td class="py-4 px-4"><%= report.supplier || 'N/A' %></td>
                  <td class="py-4 px-4">
                    <input type="text" name="received_by" value="<%= report.received_by || '' %>" 
                      class="w-full p-2 border rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-300">
                  </td>
                  <td class="py-4 px-4">
                    <input type="date" name="date_received" value="<%= report.formatted_date_received || '' %>" 
                      class="w-full p-2 border rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-300">
                  </td>
                  <td class="py-4 px-4">
                    <input type="text" name="transaction" value="<%= report.transaction || '' %>" 
                      class="w-full p-2 border rounded-lg focus:outline-none focus:ring-1 focus:ring-blue-300">
                  </td>
                  <td class="py-4 px-4"><%= report.updated_by || 'N/A' %></td>
                  <td class="py-4 px-4">
                    <div class="flex justify-center space-x-2">
                      <form action="/outgoing-reports/update" method="POST" class="inline">
                        <input type="hidden" name="outgoing_id" value="<%= report.outgoing_id %>">
                        <input type="hidden" name="received_by" value="">
                        <input type="hidden" name="date_received" value="">
                        <input type="hidden" name="transaction" value="">
                        <button type="submit" class="update-btn bg-blue-600 text-white px-3 py-1.5 rounded-lg shadow-sm hover:bg-blue-700 transition-colors no-border">
                          <i class="fas fa-save"></i>
                        </button>
                      </form>
                      <% if (report.status !== 'archived') { %>
                        <form action="/outgoing-reports/archive/<%= report.outgoing_id %>" method="POST" class="inline">
                          <button type="submit" class="archive-btn bg-yellow-500 text-white px-3 py-1.5 rounded-lg shadow-sm hover:bg-yellow-600 transition-colors no-border">
                            <i class="fas fa-archive"></i>
                          </button>
                        </form>
                      <% } else { %>
                        <form action="/outgoing-reports/unarchive/<%= report.outgoing_id %>" method="POST" class="inline">
                          <button type="submit" class="unarchive-btn bg-green-500 text-white px-3 py-1.5 rounded-lg shadow-sm hover:bg-green-600 transition-colors no-border">
                            <i class="fas fa-box-open"></i>
                          </button>
                        </form>
                      <% } %>
                    </div>
                  </td>
                </tr>
              <% }); %>
            </tbody>
          </table>
        </div>
      </div>      
    </div>
  </div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Update hidden form fields before submission
    document.querySelectorAll('.update-btn').forEach(button => {
      button.addEventListener('click', function(e) {
        const form = this.closest('form');
        const row = this.closest('tr');
        
        form.querySelector('input[name="received_by"]').value = row.querySelector('input[name="received_by"]').value;
        form.querySelector('input[name="date_received"]').value = row.querySelector('input[name="date_received"]').value;
        form.querySelector('input[name="transaction"]').value = row.querySelector('input[name="transaction"]').value;
      });
    });

    let currentFilter = 'active';

    // Filter buttons
    document.getElementById('showActive').addEventListener('click', function() {
      currentFilter = 'active';
      filterReports(currentFilter);
      this.classList.add('bg-blue-600', 'text-white');
      document.getElementById('showArchived').classList.remove('bg-gray-600', 'text-white');
    });

    document.getElementById('showArchived').addEventListener('click', function() {
      currentFilter = 'archived';
      filterReports(currentFilter);
      this.classList.add('bg-gray-600', 'text-white');
      document.getElementById('showActive').classList.remove('bg-blue-600', 'text-white');
    });

    function filterReports(status) {
      document.querySelectorAll('#reportsTableBody tr').forEach(row => {
        if (status === 'active') {
          row.style.display = row.dataset.status !== 'archived' ? '' : 'none';
        } else if (status === 'archived') {
          row.style.display = row.dataset.status === 'archived' ? '' : 'none';
        }
      });
    }

    // Initialize showing only active reports by default
    filterReports('active');
    document.getElementById('showActive').classList.add('bg-blue-600', 'text-white');

    // Search functionality with filter context
    document.getElementById('search').addEventListener('input', function() {
      const searchTerm = this.value.toLowerCase();

      document.querySelectorAll('#reportsTableBody tr').forEach(row => {
        const rowText = row.textContent.toLowerCase();
        const isMatch = rowText.includes(searchTerm);
        
        let isVisible = false;
        if (currentFilter === 'active') {
          isVisible = row.dataset.status !== 'archived' && isMatch;
        } else if (currentFilter === 'archived') {
          isVisible = row.dataset.status === 'archived' && isMatch;
        }

        row.style.display = isVisible ? '' : 'none';
      });
    });

    // Refresh functionality
    document.getElementById('refreshReports').addEventListener('click', function() {
      window.location.reload();
    });
  });
</script>
</body>
</html>