<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>Purchase Request Processing</title>
  <link href="/src/requests.css" rel="stylesheet"/>

  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="/img/Calapan_City_Logo.png" type="image/png">

  <style>
    
  </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-50 font-sans min-h-screen">
  <!-- Include Sidebar -->
  <%- include('partials/sidebar') %>

  <!-- Main Content -->
  <div class="lg:ml-64 p-7 lg:p-10">
    <div class="w-full max-w-8xl mx-auto">

<!-- In rfq.ejs -->
<div class="bg-white rounded-xl card-shadow p-6 lg:p-8">
  <div class="flex items-center justify-between mb-6 pb-4 border-b border-gray-100">
    <h2 class="text-2xl font-bold text-primary-700 flex items-center">
      <i class="fas fa-tasks mr-3 text-primary-500"></i>Purchase Request Processing
    </h2>
    <div class="text-sm text-gray-500 bg-blue-50 px-3 py-1 rounded-full">
      <i class="fas fa-list-ol mr-1"></i> 
      <span id="itemCount"><%= allItems.length %></span> Requests
    </div>
  </div>

  <!-- Progress Legend -->
  <div class="mb-8 bg-gray-50 p-4 rounded-lg">
    <div class="flex flex-wrap gap-6">
      <div class="flex items-center">
        <div class="w-3 h-3 bg-blue-500 rounded-full mr-2"></div>
        <span class="text-sm text-gray-700">RFQ Form</span>
      </div>
      <div class="flex items-center">
        <div class="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
        <span class="text-sm text-gray-700">Abstract</span>
      </div>
      <div class="flex items-center">
        <div class="w-3 h-3 bg-purple-500 rounded-full mr-2"></div>
        <span class="text-sm text-gray-700">Acceptance</span>
      </div>
      <div class="flex items-center">
        <div class="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
        <span class="text-sm text-gray-700">Purchase Order</span>
      </div>
    </div>
  </div>

  <!-- Tabs for different categories -->
  <div class="mb-6 border-b border-gray-200">
    <ul class="flex flex-wrap -mb-px">
      <li class="mr-2">
        <a href="?tab=all" 
           class="inline-block p-4 border-b-2 rounded-t-lg <%= activeTab === 'all' ? 'border-primary-600 text-primary-600' : 'border-transparent hover:text-gray-600 hover:border-gray-300' %>">
          All Requests (<%= allItems.length %>)
        </a>
      </li>
      <li class="mr-2">
        <a href="?tab=inProgress" 
           class="inline-block p-4 border-b-2 rounded-t-lg <%= activeTab === 'inProgress' ? 'border-primary-600 text-primary-600' : 'border-transparent hover:text-gray-600 hover:border-gray-300' %>">
          In Progress (<%= inProgressItems.length %>)
        </a>
      </li>
      <li class="mr-2">
        <a href="?tab=completed" 
           class="inline-block p-4 border-b-2 rounded-t-lg <%= activeTab === 'completed' ? 'border-primary-600 text-primary-600' : 'border-transparent hover:text-gray-600 hover:border-gray-300' %>">
          Completed (<%= completedItems.length %>)
        </a>
      </li>
    </ul>
  </div>

  <!-- Table -->
  <div class="overflow-x-auto rounded-lg border border-gray-200">
    <table class="w-full border-collapse">
      <thead>
        <tr class="bg-gradient-to-r from-primary-600 to-primary-700 text-white">
          <th class="p-4 text-left font-semibold">PR ID</th>
          <th class="p-4 text-left font-semibold">Description</th>
          <th class="p-4 text-left font-semibold">Status</th>
          <th class="p-4 text-left font-semibold">Next Action</th>
        </tr>
      </thead>
      <tbody>
        <% 
          // Determine which items to display based on active tab
          let displayItems = allItems;
          if (activeTab === 'inProgress') displayItems = inProgressItems;
          if (activeTab === 'completed') displayItems = completedItems;
        %>
        
        <% displayItems.forEach((item) => { %>
          <tr class="<%= displayItems.indexOf(item) % 2 === 0 ? 'bg-white' : 'bg-gray-50' %> hover:bg-blue-50 transition-all">
            <td class="p-4 border-t border-gray-200"><%= item.pr_id %></td>
            <td class="p-4 border-t border-gray-200"><%= item.item_description %></td>
            
            <!-- Interactive Progress Steps -->
            <td class="p-4 border-t border-gray-200">
              <div class="flex items-center">
                <% const steps = [
                  { 
                    name: 'rfq', 
                    completed: item.rfq_completed, 
                    color: 'blue',
                    url: `/rfqForm/${item.token}`
                  },
                  { 
                    name: 'abstract', 
                    completed: item.abstract_completed, 
                    color: 'green',
                    url: `/abstract/${item.token}`
                  },
                  { 
                    name: 'acceptance', 
                    completed: item.acceptance_completed, 
                    color: 'purple',
                    url: `/acceptance/${item.token}`
                  },
                  { 
                    name: 'po', 
                    completed: item.po_completed, 
                    color: 'orange',
                    url: `/purchase-order/${item.token}`
                  }
                ]; %>
                
                <% steps.forEach((step, index) => { %>
                  <div class="flex items-center">
                    <!-- Clickable Progress Step -->
                    <a href="<%= step.url %>" class="progress-step">
                      <% if (step.completed) { %>
                        <!-- Completed Step -->
                        <div class="w-6 h-6 rounded-full bg-<%= step.color %>-500 flex items-center justify-center text-white hover:bg-<%= step.color %>-600">
                          <i class="fas fa-check text-xs"></i>
                        </div>
                      <% } else if (step.completed === undefined || step.completed === null) { %>
                        <!-- No Data for Step -->
                        <div class="w-6 h-6 rounded-full border-2 border-gray-300 hover:border-gray-400 hover:bg-gray-100"></div>
                      <% } else { %>
                        <!-- In Progress or Not Started but Relevant -->
                        <div class="w-6 h-6 rounded-full border-2 border-<%= step.color %>-500 hover:border-<%= step.color %>-600 hover:bg-<%= step.color %>-100"></div>
                      <% } %>
                    </a>
                    
                    <!-- Connector Line (except after last step) -->
                    <% if (index < steps.length - 1) { %>
                      <a href="<%= steps[index+1].url %>" class="progress-connector w-8 h-1 bg-gray-200 hover:bg-blue-300"></a>
                    <% } %>
                  </div>
                <% }); %>
              </div>
            </td>
            
            <!-- Primary Next Action Button -->
            <td class="p-4 border-t border-gray-200">
              <% if (!item.rfq_completed) { %>
                <a href="/rfqForm/<%= item.token %>" class="flex items-center bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition-all">
                  <i class="fas fa-file-alt mr-2"></i>Start RFQ
                </a>
              <% } else if (!item.abstract_completed) { %>
                <a href="/abstract/<%= item.token %>" class="flex items-center bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 transition-all">
                  <i class="fas fa-clipboard-list mr-2"></i>Create Abstract
                </a>
              <% } else if (!item.acceptance_completed) { %>
                <a href="/acceptance/<%= item.token %>" class="flex items-center bg-purple-500 text-white px-4 py-2 rounded-lg hover:bg-purple-600 transition-all">
                  <i class="fas fa-check-circle mr-2"></i>Process Acceptance
                </a>
              <% } else if (!item.po_completed) { %>
                <a href="/purchase-order/<%= item.token %>" class="flex items-center bg-orange-500 text-white px-4 py-2 rounded-lg hover:bg-orange-600 transition-all">
                  <i class="fas fa-file-invoice-dollar mr-2"></i>Generate PO
                </a>
              <% } else { %>
                <div class="flex items-center text-green-600">
                  <i class="fas fa-check-circle mr-2"></i>
                  <span class="font-medium">Completed</span>
                </div>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>
  </div>
</div>

<script>
  // Update item count when tabs are clicked
  document.addEventListener('DOMContentLoaded', function() {
    const tabs = document.querySelectorAll('[data-tab]');
    
    tabs.forEach(tab => {
      tab.addEventListener('click', function() {
        const tabName = this.getAttribute('data-tab');
        let count = 0;
        
        if (tabName === 'all') count = <%= allItems.length %>;
        else if (tabName === 'inProgress') count = <%= inProgressItems.length %>;
        else if (tabName === 'completed') count = <%= completedItems.length %>;
        
        document.getElementById('itemCount').textContent = count;
      });
    });
  });
</script>