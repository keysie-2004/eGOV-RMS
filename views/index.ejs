<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>eGOV-RMS</title>
  <link href="/src/index.css" rel="stylesheet"/>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet"/>
  <link rel="icon" href="/img/Calapan_City_Logo.png" type="image/png"/>
</head>

<body class="bg-blue-50 font-sans">
  <div class="flex gap-10">
    <!-- Include Sidebar -->
    <%- include('partials/sidebar') %>

    <!-- Main content -->
    <div class="flex-1 ml-0 lg:ml-64 p-7">
      <div class="col-start-2 col-span-3 pl-10 pr-10 pb-10">
        <!-- Error Message -->
        <% if (typeof errorMessage !== 'undefined') { %>
          <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 mb-6 rounded-lg" role="alert">
            <p class="font-bold">Error</p>
            <p><%= errorMessage %></p>
          </div>
        <% } %>

        <!-- Stats Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-10">
          <div class="bg-gradient-to-br from-white to-blue-50 p-5 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="flex items-center mb-3">
              <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-tasks text-blue-600 text-xl"></i>
              </div>
              <span class="ml-3 text-gray-700 font-medium">Pending Requests<% if (!isAdmin) { %> (<%- userDepartment %>)<% } %></span>
            </div>
            <div class="text-3xl font-bold text-blue-800">
              <%= Number(pendingRequests).toLocaleString('en-US') %>
            </div>
          </div>
          <div class="bg-gradient-to-br from-white to-blue-50 p-5 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="flex items-center mb-3">
              <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-box text-blue-600 text-xl"></i>
              </div>
              <span class="ml-3 text-gray-700 font-medium">Property Small (< 5k)<% if (!isAdmin) { %> (<%- userDepartment %>)<% } %></span>
            </div>
            <div class="text-3xl font-bold text-blue-800">
              ₱<%= Number(propertySmall).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
            </div>
          </div>
          <div class="bg-gradient-to-br from-white to-blue-50 p-5 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="flex items-center mb-3">
              <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-wallet text-blue-600 text-xl"></i>
              </div>
              <span class="ml-3 text-gray-700 font-medium">ICS (< 50k)<% if (!isAdmin) { %> (<%- userDepartment %>)<% } %></span>
            </div>
            <div class="text-3xl font-bold text-blue-800">
              ₱<%= Number(icsBelow50k).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
            </div>
          </div>
          <div class="bg-gradient-to-br from-white to-blue-50 p-5 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="flex items-center mb-3">
              <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-truck text-blue-600 text-xl"></i>
              </div>
              <span class="ml-3 text-gray-700 font-medium">PAR (> 50k)<% if (!isAdmin) { %> (<%- userDepartment %>)<% } %></span>
            </div>
            <div class="text-3xl font-bold text-blue-800">
              ₱<%= Number(parAbove50k).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
            </div>
          </div>
          <div class="bg-gradient-to-br from-white to-blue-50 p-5 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="flex items-center mb-3">
              <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-money-bill text-blue-600 text-xl"></i>
              </div>
              <span class="ml-3 text-gray-700 font-medium">Total Spending<% if (!isAdmin) { %> (<%- userDepartment %>)<% } %></span>
            </div>
            <div class="text-3xl font-bold text-blue-800">
              ₱<%= Number(totalSpent).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
            </div>
          </div>
          <div class="bg-gradient-to-br from-white to-blue-50 p-5 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="flex items-center mb-3">
              <div class="p-3 bg-blue-100 rounded-full">
                <i class="fas fa-users text-blue-600 text-xl"></i>
              </div>
              <span class="ml-3 text-gray-700 font-medium">Total Employees<% if (!isAdmin) { %> (<%- userDepartment %>)<% } %></span>
            </div>
            <div class="text-3xl font-bold text-blue-800">
              <%= Number(totalEmployees).toLocaleString('en-US') %>
            </div>
          </div>
        </div>

        <!-- Predicted Budget Section -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-6 hover:shadow-lg transition-all duration-300">
          <div class="flex items-center mb-4">
            <i class="fas fa-chart-pie text-blue-600 text-2xl"></i>
            <span class="ml-3 text-gray-700 font-medium">
              Predicted Budget<% if (!isSuperAdmin && userDepartment) { %> for <%- userDepartment %><% } else { %> by Department (Next Year)<% } %>
            </span>
          </div>
          <div class="h-80 mb-6">
            <canvas id="departmentBudgetChart"></canvas>
          </div>
          <% if (isSuperAdmin && predictionsAvailable && filteredDepartments.length > 10) { %>
            <div class="text-center">
              <button onclick="openDepartmentModal()" class="text-blue-600 hover:text-blue-800 font-medium bg-blue-100 px-4 py-2 rounded-lg hover:bg-blue-200 transition-colors">
                View All Departments <i class="fas fa-chevron-down ml-1"></i>
              </button>
            </div>
          <% } %>
        </div>

        <!-- Department Modal (only for superadmins) -->
        <% if (isSuperAdmin) { %>
        <div id="departmentModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
          <div class="bg-white rounded-xl shadow-xl w-11/12 md:w-3/4 lg:w-2/3 max-h-[90vh] overflow-y-auto">
            <div class="p-6">
              <div class="flex justify-between items-center mb-4">
                <h2 class="text-2xl font-bold text-blue-700">All Department Budget Predictions</h2>
                <button onclick="closeDepartmentModal()" class="text-gray-500 hover:text-gray-700 p-2 rounded-full hover:bg-gray-100">
                  <i class="fas fa-times text-xl"></i>
                </button>
              </div>
              <div class="h-96">
                <canvas id="allDepartmentBudgetChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        <% } %>

        <!-- Budget Forecast Section -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
          <!-- Yearly Budget Forecast Chart -->
          <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="flex items-center mb-4">
              <i class="fas fa-chart-line text-blue-600 text-2xl"></i>
              <span class="ml-3 text-gray-700 font-medium">5-Year Budget Forecast<% if (!isAdmin) { %> (<%- userDepartment %>)<% } %></span>
            </div>
            <div class="h-64">
              <canvas id="yearlyForecastChart"></canvas>
            </div>
            <div class="mt-4 text-sm text-gray-500">
              <i class="fas fa-info-circle mr-1"></i>
              Projected budget needs based on historical ICS spending patterns
            </div>
            <% if (formattedYearlyData.data && formattedYearlyData.data.every(val => val === 0)) { %>
              <div class="text-center text-gray-500 mt-2">Generating forecast based on available data...</div>
            <% } else { %>
              <div class="text-xs text-gray-400 mt-2">
                <i class="fas fa-database mr-1"></i>
                Data Source: ICS Records (<%= yearlyForecastData.length %> data points)
              </div>
            <% } %>
          </div>
          
          <!-- Department Budget Distribution Pie Chart -->
          <div class="bg-white p-6 rounded-xl shadow-sm hover:shadow-lg transition-all duration-300">
            <div class="flex items-center mb-4">
              <i class="fas fa-chart-pie text-blue-600 text-2xl"></i>
              <span class="ml-3 text-gray-700 font-medium">Department Budget Distribution<% if (!isAdmin) { %> (<%- userDepartment %>)<% } %></span>
            </div>
            <div class="h-64">
              <canvas id="departmentDistributionChart"></canvas>
            </div>
            <div class="mt-4 text-sm text-gray-500">
              <i class="fas fa-info-circle mr-1"></i>
              Percentage allocation based on ICS spending<% if (!isAdmin) { %> for <%- userDepartment %><% } else { %> across major departments<% } %>
            </div>
            <% if (formattedDistributionData.data && formattedDistributionData.data.every(val => val === 0) || (formattedDistributionData.labels && formattedDistributionData.labels[0] === 'No Data')) { %>
              <div class="text-center text-gray-500 mt-2">No ICS data available for distribution</div>
            <% } else { %>
              <div class="text-xs text-gray-400 mt-2">
                <i class="fas fa-database mr-1"></i>
                Data Source: ICS Records (<%= departmentDistributionData.length %> departments)
              </div>
            <% } %>
          </div>
        </div>

        <!-- Monthly Spending Trend -->
        <div class="bg-white p-6 rounded-xl shadow-sm mb-6 hover:shadow-lg transition-all duration-300">
          <div class="flex items-center mb-4">
            <i class="fas fa-calendar-alt text-blue-600 text-2xl"></i>
            <span class="ml-3 text-gray-700 font-medium">Monthly Spending Trend (Current Year)<% if (!isAdmin) { %> (<%- userDepartment %>)<% } %></span>
          </div>
          <div class="h-80">
            <canvas id="monthlyTrendChart"></canvas>
          </div>
          <div class="mt-4 text-sm text-gray-500">
            <i class="fas fa-info-circle mr-1"></i>
            ICS (< 50k) vs PAR (≥ 50k) spending comparison
          </div>
         <!-- <% if (formattedMonthlyData && formattedMonthlyData.icsData && formattedMonthlyData.parData && formattedMonthlyData.icsData.every(val => val === 0) && formattedMonthlyData.parData.every(val => val === 0)) { %>
  <div class="text-center text-gray-500 mt-2">Monthly spending data will appear here as transactions are recorded</div>
<% } else { %> -->
            <div class="flex justify-between items-center mt-4">
              <div class="text-xs text-gray-400">
                <i class="fas fa-database mr-1"></i>
                Data Source: ICS Records
              </div>
              <div class="flex items-center space-x-4">
                <div class="flex items-center">
                  <div class="w-3 h-3 bg-indigo-500 rounded-full mr-2"></div>
                  <span class="text-xs text-gray-600">ICS (< 50k)</span>
                </div>
                <div class="flex items-center">
                  <div class="w-3 h-3 bg-emerald-500 rounded-full mr-2"></div>
                  <span class="text-xs text-gray-600">PAR (≥ 50k)</span>
                </div>
              </div>
            </div>
          <% } %>
        </div>

        <!-- Debug Information (can be removed in production) -->
        <% if (false) { %>
        <div class="bg-gray-100 p-4 rounded-lg mt-6">
          <h3 class="font-bold text-gray-700 mb-2">Debug Information:</h3>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <h4 class="font-medium text-gray-600">Yearly Forecast Data:</h4>
              <pre class="text-xs overflow-auto max-h-40"><%= JSON.stringify(yearlyForecastData, null, 2) %></pre>
            </div>
            <div>
              <h4 class="font-medium text-gray-600">Distribution Data:</h4>
              <pre class="text-xs overflow-auto max-h-40"><%= JSON.stringify(departmentDistributionData, null, 2) %></pre>
            </div>
            <div>
              <h4 class="font-medium text-gray-600">Monthly Data:</h4>
              <pre class="text-xs overflow-auto max-h-40"><%= JSON.stringify(monthlySpendingData, null, 2) %></pre>
            </div>
          </div>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    // Department Modal Functions
    function openDepartmentModal() {
      document.getElementById('departmentModal')?.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }

    function closeDepartmentModal() {
      document.getElementById('departmentModal')?.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    }

    document.getElementById('departmentModal')?.addEventListener('click', function(e) {
      if (e.target === this) {
        closeDepartmentModal();
      }
    });

    // Dynamic data from server
    const departmentPredictions = <%- JSON.stringify(departmentPredictions || {}) %>;
    const formattedYearlyData = <%- JSON.stringify(formattedYearlyData || { labels: [], data: [] }) %>;
    const formattedDistributionData = <%- JSON.stringify(formattedDistributionData || { labels: [], data: [], percentages: [] }) %>;
    const formattedMonthlyData = <%- JSON.stringify(formattedMonthlyData || { labels: [], icsData: [], parData: [] }) %>;
    const isSuperAdmin = <%- isSuperAdmin ? 'true' : 'false' %>;
    const isAdmin = <%- isAdmin ? 'true' : 'false' %>;
    const userDepartment = <%- JSON.stringify(userDepartment || '') %>;
    const filteredDepartmentsData = <%- JSON.stringify(filteredDepartments || []) %>;

    console.log('Dashboard Debug Info:', {
      departmentPredictions,
      formattedYearlyData,
      formattedDistributionData,
      formattedMonthlyData,
      filteredDepartmentsData,
      isSuperAdmin,
      isAdmin,
      userDepartment
    });

    // Process filteredDepartments properly - handle both array and object formats
    let processedDepartments = [];
    let topDepartments = [];
    
    if (Array.isArray(filteredDepartmentsData) && filteredDepartmentsData.length > 0) {
      // If it's already an array from the server
      processedDepartments = filteredDepartmentsData.filter(item => item && item[1] > 0)
        .sort((a, b) => b[1] - a[1]);
      topDepartments = isSuperAdmin ? processedDepartments.slice(0, 10) : processedDepartments.slice(0, 1);
    } else if (departmentPredictions && typeof departmentPredictions === 'object') {
      // Fallback to old format
      processedDepartments = Object.entries(departmentPredictions)
        .filter(([dept, amount]) => amount > 0)
        .sort((a, b) => b[1] - a[1]);
      topDepartments = isSuperAdmin ? processedDepartments.slice(0, 10) : processedDepartments.slice(0, 1);
    }

    console.log('Processed Departments:', processedDepartments);
    console.log('Top Departments:', topDepartments);

    // Department Budget Chart
    if (document.getElementById('departmentBudgetChart')) {
      const departmentBudgetCtx = document.getElementById('departmentBudgetChart').getContext('2d');
      
      const chartLabels = topDepartments.map((item) => {
        if (Array.isArray(item)) {
          return item[0] || 'Unknown Department'; // item[0] is department code/name
        }
        return 'Department';
      });
      
      const chartData = topDepartments.map((item) => {
        if (Array.isArray(item)) {
          return (item[1] || 0) / 1000000; // item[1] is amount
        }
        return 0;
      });

      console.log('Department Budget Chart Data:', {
        labels: chartLabels,
        data: chartData
      });

      if (chartData.length > 0 && chartData.some(val => val > 0)) {
        new Chart(departmentBudgetCtx, {
          type: 'bar',
          data: {
            labels: chartLabels,
            datasets: [{
              label: 'Predicted Budget (₱)',
              data: chartData,
              backgroundColor: 'rgba(79, 70, 229, 0.6)',
              borderColor: '#4F46E5',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return '₱' + (context.raw * 1000000).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  font: { size: 12 }
                }
              },
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '₱' + value + 'M';
                  }
                }
              }
            }
          }
        });
      } else {
        // Display a message instead of chart
        departmentBudgetCtx.canvas.style.display = 'none';
        const container = document.getElementById('departmentBudgetChart').parentElement;
        const message = document.createElement('div');
        message.className = 'text-center text-gray-500 py-8 flex flex-col items-center justify-center h-full';
        message.innerHTML = '<i class="fas fa-chart-pie text-4xl mb-3 text-gray-300"></i><p class="text-gray-500 font-medium">No department budget predictions available</p>';
        container.appendChild(message);
      }
    }

    // All Department Budget Chart (Modal)
    <% if (isSuperAdmin) { %>
    if (document.getElementById('allDepartmentBudgetChart')) {
      const allDepartmentBudgetCtx = document.getElementById('allDepartmentBudgetChart').getContext('2d');
      
      const allChartLabels = processedDepartments.map((item) => {
        if (Array.isArray(item)) {
          return item[0] || 'Unknown Department';
        }
        return 'Department';
      });
      
      const allChartData = processedDepartments.map((item) => {
        if (Array.isArray(item)) {
          return (item[1] || 0) / 1000000;
        }
        return 0;
      });

      if (allChartData.length > 0 && allChartData.some(val => val > 0)) {
        new Chart(allDepartmentBudgetCtx, {
          type: 'bar',
          data: {
            labels: allChartLabels,
            datasets: [{
              label: 'Predicted Budget (₱)',
              data: allChartData,
              backgroundColor: 'rgba(79, 70, 229, 0.6)',
              borderColor: '#4F46E5',
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return '₱' + (context.raw * 1000000).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                  }
                }
              }
            },
            scales: {
              x: {
                ticks: {
                  maxRotation: 45,
                  minRotation: 45,
                  font: { size: 12 }
                }
              },
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '₱' + value + 'M';
                  }
                }
              }
            }
          }
        });
      } else {
        allDepartmentBudgetCtx.canvas.style.display = 'none';
        const container = document.getElementById('allDepartmentBudgetChart').parentElement;
        const message = document.createElement('div');
        message.className = 'text-center text-gray-500 py-8 flex flex-col items-center justify-center h-full';
        message.innerHTML = '<i class="fas fa-chart-pie text-4xl mb-3 text-gray-300"></i><p class="text-gray-500 font-medium">No department budget predictions available</p>';
        container.appendChild(message);
      }
    }
    <% } %>

    // Yearly Forecast Chart - UPDATED
    if (document.getElementById('yearlyForecastChart')) {
      const yearlyForecastCtx = document.getElementById('yearlyForecastChart').getContext('2d');
      
      // Prepare data - ensure we have valid numbers
      const yearlyLabels = formattedYearlyData.labels || [];
      const yearlyData = formattedYearlyData.data ? formattedYearlyData.data.map(val => parseFloat(val) || 0) : [];
      
      // Check if we have valid forecast data (not all zeros or empty)
      const hasYearlyData = yearlyLabels.length > 0 && 
                            yearlyData.length > 0 && 
                            yearlyData.some(val => val > 0);
      
      console.log('Yearly Forecast Data:', {
        labels: yearlyLabels,
        data: yearlyData,
        hasYearlyData: hasYearlyData
      });
      
      if (hasYearlyData) {
        new Chart(yearlyForecastCtx, {
          type: 'line',
          data: {
            labels: yearlyLabels,
            datasets: [{
              label: 'Budget Forecast (in millions)',
              data: yearlyData,
              borderColor: '#4F46E5',
              backgroundColor: 'rgba(79, 70, 229, 0.1)',
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#4F46E5',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return '₱' + (context.raw * 1000000).toLocaleString('en-US', { minimumFractionDigits: 2 }) + ' (projected)';
                  }
                }
              }
            },
            scales: {
              x: {
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                title: {
                  display: true,
                  text: 'Year'
                }
              },
              y: {
                beginAtZero: true,
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  callback: function(value) {
                    return '₱' + value.toFixed(2) + 'M';
                  }
                },
                title: {
                  display: true,
                  text: 'Predicted Budget'
                }
              }
            }
          }
        });
      } else {
        // Display a message instead of chart
        yearlyForecastCtx.canvas.style.display = 'none';
        const container = document.getElementById('yearlyForecastChart').parentElement;
        const message = document.createElement('div');
        message.className = 'text-center text-gray-500 py-8 flex flex-col items-center justify-center h-full';
        message.innerHTML = '<i class="fas fa-chart-line text-4xl mb-3 text-gray-300"></i><p class="text-gray-500 font-medium">Generating forecast based on available data...</p>';
        container.appendChild(message);
      }
    }

    // Department Distribution Pie Chart - UPDATED
    if (document.getElementById('departmentDistributionChart')) {
      const departmentDistributionCtx = document.getElementById('departmentDistributionChart').getContext('2d');
      
      // Prepare data
      const distributionLabels = formattedDistributionData.labels || [];
      const distributionData = formattedDistributionData.data ? formattedDistributionData.data.map(val => parseFloat(val) || 0) : [];
      const distributionPercentages = formattedDistributionData.percentages || [];
      
      // Check if we have valid data (not just "No Data")
      const hasValidData = distributionLabels.length > 0 && 
                          distributionLabels[0] !== 'No Data' && 
                          distributionData.some(val => val > 0);
      
      console.log('Distribution Chart Data:', {
        labels: distributionLabels,
        data: distributionData,
        percentages: distributionPercentages,
        hasValidData: hasValidData
      });
      
      if (hasValidData) {
        new Chart(departmentDistributionCtx, {
          type: 'doughnut',
          data: {
            labels: distributionLabels,
            datasets: [{
              data: distributionData,
              backgroundColor: isAdmin ? [
                '#4F46E5',
                '#10B981',
                '#F59E0B',
                '#EF4444',
                '#6B7280',
                '#8B5CF6',
                '#EC4899',
                '#14B8A6',
                '#F97316',
                '#64748B'
              ] : ['#4F46E5'],
              borderWidth: 1,
              borderColor: '#ffffff'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '60%',
            plugins: {
              legend: {
                position: 'right',
                labels: { 
                  font: { size: 12 },
                  padding: 15
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const value = context.raw;
                    const percentage = distributionPercentages[context.dataIndex] || 0;
                    return `${context.label}: ₱${(value * 1000000).toLocaleString('en-US', { minimumFractionDigits: 2 })} (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      } else {
        // Display a message instead of chart
        departmentDistributionCtx.canvas.style.display = 'none';
        const container = document.getElementById('departmentDistributionChart').parentElement;
        const message = document.createElement('div');
        message.className = 'text-center text-gray-500 py-8 flex flex-col items-center justify-center h-full';
        message.innerHTML = '<i class="fas fa-chart-pie text-4xl mb-3 text-gray-300"></i><p class="text-gray-500 font-medium">No ICS data available for distribution</p>';
        container.appendChild(message);
      }
    }

    // Monthly Trend Chart - UPDATED
    // Monthly Trend Chart - REAL DATA ONLY
    if (document.getElementById('monthlyTrendChart')) {
      const monthlyTrendCtx = document.getElementById('monthlyTrendChart').getContext('2d');
      
      // Prepare data
      const monthlyLabels = formattedMonthlyData.labels || ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const icsData = formattedMonthlyData.icsData ? formattedMonthlyData.icsData.map(val => parseFloat(val) || 0) : Array(12).fill(0);
      const parData = formattedMonthlyData.parData ? formattedMonthlyData.parData.map(val => parseFloat(val) || 0) : Array(12).fill(0);
      
      // Check if we have any real data
      const hasData = icsData.some(val => val > 0) || parData.some(val => val > 0);
      
      console.log('Monthly Chart Data:', {
        hasData: hasData,
        icsDataTotal: icsData.reduce((a, b) => a + b, 0),
        parDataTotal: parData.reduce((a, b) => a + b, 0),
        rawData: formattedMonthlyData
      });
      
      if (hasData) {
        new Chart(monthlyTrendCtx, {
          type: 'bar',
          data: {
            labels: monthlyLabels,
            datasets: [
              {
                label: 'ICS Spending (< ₱50k)',
                data: icsData,
                backgroundColor: 'rgba(79, 70, 229, 0.7)',
                borderColor: '#4F46E5',
                borderWidth: 1
              },
              {
                label: 'PAR Spending (≥ ₱50k)',
                data: parData,
                backgroundColor: 'rgba(16, 185, 129, 0.7)',
                borderColor: '#10B981',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              intersect: false,
              mode: 'index'
            },
            scales: {
              x: {
                stacked: true,
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: { 
                  font: { size: 12 }
                },
                title: {
                  display: true,
                  text: 'Month'
                }
              },
              y: {
                stacked: true,
                beginAtZero: true,
                grid: {
                  display: true,
                  color: 'rgba(0, 0, 0, 0.05)'
                },
                ticks: {
                  callback: function(value) {
                    return '₱' + value.toFixed(2) + 'M';
                  },
                  font: { size: 12 }
                },
                title: {
                  display: true,
                  text: 'Spending Amount'
                }
              }
            },
            plugins: {
              legend: {
                position: 'top',
                labels: { 
                  font: { size: 14 },
                  padding: 15
                }
              },
              tooltip: {
                mode: 'index',
                intersect: false,
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    label += '₱' + (context.raw * 1000000).toLocaleString('en-US', { minimumFractionDigits: 2 });
                    return label;
                  }
                }
              }
            }
          }
        });
      } else {
        // Display an informative message instead of a chart
        monthlyTrendCtx.canvas.style.display = 'none';
        const container = document.getElementById('monthlyTrendChart').parentElement;
        
        // Create message container
        const messageContainer = document.createElement('div');
        messageContainer.className = 'text-center py-8 flex flex-col items-center justify-center h-full';
        
        // Check if there's any ICS data at all
        const hasICSTotal = <%= totalSpent %> > 0;
        
        if (hasICSTotal) {
          // There's ICS data but not broken down by month
          messageContainer.innerHTML = `
            <i class="fas fa-database text-4xl mb-3 text-blue-300"></i>
            <p class="text-gray-600 font-medium mb-2">Monthly Spending Breakdown</p>
            <p class="text-gray-500 text-sm mb-4">ICS data exists but needs to be analyzed by month.</p>
            <div class="bg-blue-50 p-3 rounded-lg max-w-md">
              <p class="text-xs text-gray-600">Total ICS Spending: ₱<%= Number(totalSpent).toLocaleString('en-US', { minimumFractionDigits: 2 }) %></p>
            </div>
          `;
        } else {
          // No ICS data at all
          messageContainer.innerHTML = `
            <i class="fas fa-calendar-alt text-4xl mb-3 text-gray-300"></i>
            <p class="text-gray-600 font-medium mb-2">No Monthly Spending Data Yet</p>
            <p class="text-gray-500 text-sm">Monthly spending trends will appear here once ICS transactions are recorded in the system.</p>
            <div class="mt-4 text-xs text-gray-400">
              <i class="fas fa-info-circle mr-1"></i>
              ICS records with purchase dates are needed for this chart
            </div>
          `;
        }
        
        container.appendChild(messageContainer);
      }
    }
    
  </script>
</body>
</html>