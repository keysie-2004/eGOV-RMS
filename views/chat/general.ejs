<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>General Chat | eGOV-RMS</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link href="/src/requests.css" rel="stylesheet"/>
  <style>
    .message-in {
      background-color: #f3f4f6;
      border-radius: 1rem 1rem 1rem 0;
      max-width: 80%;
    }
    
    .message-out {
      background-color: #3b82f6;
      color: white;
      border-radius: 1rem 1rem 0 1rem;
      max-width: 80%;
      margin-left: auto;
    }
    
    .chat-messages {
      height: calc(100vh - 220px);
      overflow-y: auto;
    }
    
    .animate-message {
      animation: fadeIn 0.3s ease-out;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Date separator */
    .date-separator {
      display: flex;
      align-items: center;
      margin: 16px 0;
      color: #6b7280;
      font-size: 12px;
    }
    
    .date-separator::before,
    .date-separator::after {
      content: "";
      flex: 1;
      height: 1px;
      background: #e5e7eb;
      margin: 0 8px;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      
      .chat-messages {
        height: calc(100vh - 180px);
      }
      
      .message-in,
      .message-out {
        max-width: 90%;
      }
      
      .main-content {
        padding: 1rem;
      }
      
      .chat-header h1 {
        font-size: 1.25rem;
      }
    }

    @media (min-width: 769px) {
      .main-content {
        padding: 2rem;
      }
    }

    /* Better mobile chat layout */
    .chat-container {
      width: 100%;
    }

    /* Header styling similar to support chat */
    .chat-header {
      background-color: white;
      border-bottom: 1px solid #e5e7eb;
      padding: 1rem;
      border-radius: 0.75rem 0.75rem 0 0;
    }

    .chat-body {
      border-radius: 0 0 0.75rem 0.75rem;
      overflow: hidden;
    }

    .input-area {
      background-color: #f9fafb;
      border-top: 1px solid #e5e7eb;
      padding: 1rem;
    }

    /* Mobile menu overlay */
    .sidebar.mobile-open {
      position: fixed;
      top: 0;
      left: 0;
      z-index: 40;
      height: 100vh;
      width: 16rem;
    }

    .mobile-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      z-index: 30;
    }

    .mobile-overlay.active {
      display: block;
    }
  </style>
</head>
<body class="bg-gray-50" data-user-id="<%= user.employee_id %>">
  <!-- Mobile overlay -->
  <div class="mobile-overlay" id="mobileOverlay"></div>
  
  <div class="flex h-screen overflow-hidden">
    <!-- Sidebar -->
    <div class="sidebar w-64 bg-white border-r border-gray-200 h-screen hidden md:block" id="sidebar">
      <%- include('../partials/sidebar') %>
    </div>
    
    <!-- Mobile menu button -->
    <div class="md:hidden fixed top-4 left-4 z-50">
      <button id="mobileMenuBtn" class="p-2 bg-white rounded-md shadow-md border border-gray-200">
        <i class="fas fa-bars text-gray-600"></i>
      </button>
    </div>
    
    <!-- Main Content -->
    <div class="flex-1 overflow-auto">
      <main class="main-content">
        <!-- Chat Container -->
        <div class="chat-container bg-white rounded-xl shadow-sm border border-gray-200 chat-body">
          <!-- Chat Header -->
          <div class="chat-header">
            <div class="flex items-center space-x-3">
              <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center">
                <i class="fas fa-users text-blue-600"></i>
              </div>
              <div>
                <h1 class="text-xl font-semibold text-gray-800">General Chat</h1>
                <p class="text-sm text-gray-600">Chat with all employees</p>
              </div>
            </div>
          </div>
          
          <!-- Messages Area -->
          <div class="chat-messages p-4 bg-gray-50" id="chatMessages">
            <% if (history.length === 0) { %>
              <div class="text-center py-10 text-gray-500">
                <i class="fas fa-comments text-4xl mb-3"></i>
                <p>No messages yet. Start the conversation!</p>
              </div>
            <% } else { %>
              <% let currentDate = ''; %>
              <% history.forEach(msg => { 
                  const messageDate = new Date(msg.timestamp).toLocaleDateString();
                  if (messageDate !== currentDate) {
                    currentDate = messageDate;
              %>
                <div class="date-separator">
                  <%= new Date(msg.timestamp).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' }) %>
                </div>
              <% } %>
                <div class="mb-4 <%= msg.isCurrentUser ? 'message-out' : 'message-in' %> p-3 animate-message" data-message-id="<%= msg.id %>">
                  <% if (!msg.isCurrentUser) { %>
                    <div>
                      <div class="font-medium text-sm text-gray-700"><%= msg.employee_name %></div>
                      <div class="text-gray-800"><%= msg.message %></div>
                      <div class="text-xs text-gray-500 mt-1"><%= msg.formattedTime %></div>
                    </div>
                  <% } else { %>
                    <div class="text-right">
                      <div class="text-white"><%= msg.message %></div>
                      <div class="text-xs text-blue-100 mt-1"><%= msg.formattedTime %></div>
                    </div>
                  <% } %>
                </div>
              <% }); %>
            <% } %>
          </div>
          
          <!-- Input Area -->
          <div class="input-area">
            <form id="messageForm" class="flex items-center space-x-3">
              <div class="flex-1 relative">
                <input type="text" id="messageInput" placeholder="Type your message..." 
                       class="w-full pl-4 pr-12 py-3 border border-gray-300 rounded-full focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
              </div>
              
              <button type="submit" class="p-3 bg-blue-600 text-white rounded-full hover:bg-blue-700 transition-colors">
                <i class="fas fa-paper-plane"></i>
              </button>
            </form>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const messageForm = document.getElementById('messageForm');
      const messageInput = document.getElementById('messageInput');
      const chatMessages = document.getElementById('chatMessages');
      const mobileMenuBtn = document.getElementById('mobileMenuBtn');
      const sidebar = document.getElementById('sidebar');
      const mobileOverlay = document.getElementById('mobileOverlay');
      const currentUserId = parseInt(document.body.dataset.userId);
      let lastMessageId = 0;
      let isScrolledUp = false;

      // Mobile menu toggle
      if (mobileMenuBtn) {
        mobileMenuBtn.addEventListener('click', function() {
          sidebar.classList.toggle('hidden');
          sidebar.classList.toggle('mobile-open');
          mobileOverlay.classList.toggle('active');
        });
        
        // Close mobile menu when clicking overlay
        mobileOverlay.addEventListener('click', function() {
          sidebar.classList.add('hidden');
          sidebar.classList.remove('mobile-open');
          mobileOverlay.classList.remove('active');
        });
      }

      // Initial load
      loadMessages();
      
      // Set up scroll detection
      chatMessages.addEventListener('scroll', function() {
        const { scrollTop, scrollHeight, clientHeight } = chatMessages;
        isScrolledUp = scrollHeight - (scrollTop + clientHeight) > 100;
      });

      // Form submission
      messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        
        if (message) {
          sendMessage(message);
          messageInput.value = '';
        }
      });

      // Load all messages
      function loadMessages() {
        fetch('/chat/history')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              displayMessages(data.history);
              // Start checking for new messages after initial load
              setInterval(checkForNewMessages, 2000);
            }
          })
          .catch(error => {
            console.error('Error loading messages:', error);
          });
      }

      // Check for new messages
      function checkForNewMessages() {
        fetch(`/chat/new-messages?lastId=${lastMessageId}`)
          .then(response => response.json())
          .then(data => {
            if (data.success && data.newMessages.length > 0) {
              addNewMessages(data.newMessages);
            }
          })
          .catch(error => {
            console.error('Error checking for new messages:', error);
          });
      }

      // Display all messages
      function displayMessages(messages) {
        chatMessages.innerHTML = '';
        
        if (messages.length === 0) {
          showNoMessages();
          return;
        }
        
        let currentDate = '';
        messages.forEach(msg => {
          const messageDate = new Date(msg.timestamp).toLocaleDateString();
          if (messageDate !== currentDate) {
            currentDate = messageDate;
            const dateSeparator = document.createElement('div');
            dateSeparator.className = 'date-separator';
            dateSeparator.textContent = new Date(msg.timestamp).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
            chatMessages.appendChild(dateSeparator);
          }
          chatMessages.appendChild(createMessageElement(msg));
          // Track the latest message ID
          if (msg.id > lastMessageId) {
            lastMessageId = msg.id;
          }
        });
        
        scrollToBottom();
      }

      // Add only new messages
      function addNewMessages(messages) {
        // Remove "no messages" placeholder if it exists
        const noMessagesDiv = chatMessages.querySelector('.text-center');
        if (noMessagesDiv) noMessagesDiv.remove();
        
        const fragment = document.createDocumentFragment();
        let currentDate = '';
        const lastMessage = chatMessages.lastElementChild && chatMessages.lastElementChild.classList.contains('date-separator')
          ? null
          : chatMessages.lastElementChild;
        if (lastMessage && lastMessage.dataset.messageId) {
          const lastMsg = messages.find(m => m.id == lastMessage.dataset.messageId);
          if (lastMsg) {
            currentDate = new Date(lastMsg.timestamp).toLocaleDateString();
          }
        }
        
        messages.forEach(msg => {
          // Only add if we don't already have this message
          if (!document.querySelector(`[data-message-id="${msg.id}"]`)) {
            const messageDate = new Date(msg.timestamp).toLocaleDateString();
            if (messageDate !== currentDate) {
              currentDate = messageDate;
              const dateSeparator = document.createElement('div');
              dateSeparator.className = 'date-separator';
              dateSeparator.textContent = new Date(msg.timestamp).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
              fragment.appendChild(dateSeparator);
            }
            fragment.appendChild(createMessageElement(msg));
            // Update last message ID
            if (msg.id > lastMessageId) {
              lastMessageId = msg.id;
            }
          }
        });
        
        if (fragment.children.length > 0) {
          chatMessages.appendChild(fragment);
          // Only scroll if user hasn't scrolled up
          if (!isScrolledUp) {
            scrollToBottom();
          }
        }
      }

      // Send message
      function sendMessage(message) {
        const button = messageForm.querySelector('button');
        button.disabled = true;
        
        fetch('/chat/send', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            chatType: 'general',
            message: message
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Optimistically add the message to the chat
            const tempMessage = {
              id: data.messageId || 'temp-' + Date.now(),
              message: message,
              sender_id: currentUserId,
              employee_name: '<%= user.employee_name %>',
              formattedTime: new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
              timestamp: new Date().toISOString(),
              isCurrentUser: true
            };
            
            // Remove "no messages" placeholder if it exists
            const noMessagesDiv = chatMessages.querySelector('.text-center');
            if (!noMessagesDiv) {
              // Check if the date separator is needed
              const lastMessage = chatMessages.lastElementChild && chatMessages.lastElementChild.classList.contains('date-separator')
                ? null
                : chatMessages.lastElementChild;
              let currentDate = '';
              if (lastMessage && lastMessage.dataset.messageId) {
                const lastMsg = messages.find(m => m.id == lastMessage.dataset.messageId);
                if (lastMsg) {
                  currentDate = new Date(lastMsg.timestamp).toLocaleDateString();
                }
              }
              const messageDate = new Date(tempMessage.timestamp).toLocaleDateString();
              if (messageDate !== currentDate) {
                const dateSeparator = document.createElement('div');
                dateSeparator.className = 'date-separator';
                dateSeparator.textContent = new Date(tempMessage.timestamp).toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                chatMessages.appendChild(dateSeparator);
              }
            } else {
              noMessagesDiv.remove();
            }
            
            chatMessages.appendChild(createMessageElement(tempMessage));
            scrollToBottom();
          }
        })
        .catch(error => {
          console.error('Error sending message:', error);
          alert('Failed to send message. Please try again.');
        })
        .finally(() => {
          button.disabled = false;
        });
      }

      // Create message element
      function createMessageElement(msg) {
        const isCurrentUser = msg.sender_id === currentUserId;
        const messageClass = isCurrentUser ? 'message-out' : 'message-in';
        
        const messageDiv = document.createElement('div');
        messageDiv.className = `mb-4 ${messageClass} p-3 animate-message`;
        messageDiv.dataset.messageId = msg.id;
        
        if (!isCurrentUser) {
          messageDiv.innerHTML = `
            <div>
              <div class="font-medium text-sm text-gray-700">${msg.employee_name}</div>
              <div class="text-gray-800">${msg.message}</div>
              <div class="text-xs text-gray-500 mt-1">${msg.formattedTime}</div>
            </div>
          `;
        } else {
          messageDiv.innerHTML = `
            <div class="text-right">
              <div class="text-white">${msg.message}</div>
              <div class="text-xs text-blue-100 mt-1">${msg.formattedTime}</div>
            </div>
          `;
        }
        
        return messageDiv;
      }

      // Show "no messages" placeholder
      function showNoMessages() {
        chatMessages.innerHTML = `
          <div class="text-center py-10 text-gray-500">
            <i class="fas fa-comments text-4xl mb-3"></i>
            <p>No messages yet. Start the conversation!</p>
          </div>
        `;
      }

      // Scroll to bottom
      function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }
    });
  </script>
</body>
</html>